# E2B æ²™ç®±è¶…æ—¶é—®é¢˜è¯Šæ–­ä¸ä¿®å¤æ–¹æ¡ˆ

## ğŸ” é—®é¢˜è¯Šæ–­ç»“æœï¼ˆUltra-think æ¨¡å¼ï¼‰

### é—®é¢˜ç°è±¡
ç”¨æˆ·åœ¨ Docker ç¯å¢ƒä¸­çœ‹åˆ°é”™è¯¯ä¿¡æ¯ï¼š
- "Failed to create or restore sandbox"
- "Failed to create sandbox: fetch failed"
- å‰ç«¯æ˜¾ç¤º"Build Errors Detected"

### æ ¹æœ¬åŸå› åˆ†æ

ç»è¿‡æ·±åº¦è¯Šæ–­ï¼Œå‘ç°é—®é¢˜çš„çœŸå®åŸå› æ˜¯ï¼š

**âœ… E2B æ²™ç®±åˆ›å»ºå®é™…ä¸Šæ˜¯æˆåŠŸçš„ï¼**

ä½†æ˜¯åˆ›å»ºæ—¶é—´è¿‡é•¿å¯¼è‡´å‰ç«¯è¶…æ—¶ï¼š

1. **å®é™…åˆ›å»ºæ—¶é—´**ï¼š32 ç§’
2. **æµè§ˆå™¨é»˜è®¤è¶…æ—¶**ï¼šé€šå¸¸ 30 ç§’
3. **ç»“æœ**ï¼šå‰ç«¯è¶…æ—¶è®¤ä¸ºè¯·æ±‚å¤±è´¥ï¼Œä½†åç«¯å®é™…åˆ›å»ºæˆåŠŸ

### è¯Šæ–­è¯æ®

#### 1. ç½‘ç»œè¿æ¥æµ‹è¯•
```bash
# å®¹å™¨å†…å¯ä»¥æ­£å¸¸è®¿é—® E2B API
âœ… DNS è§£ææˆåŠŸ: api.e2b.app -> 34.102.227.47
âœ… HTTPS è¿æ¥æˆåŠŸ: TLSv1.3 handshake completed
âœ… Fetch API æµ‹è¯•æˆåŠŸ: HTTP 200 OK
```

#### 2. ç¯å¢ƒå˜é‡æ£€æŸ¥
```bash
âœ… SANDBOX_PROVIDER=e2b
âœ… E2B_API_KEY=e2b_e576fb99a582d9785ff0fc81498451e14fbf1704 (configured)
```

#### 3. æ²™ç®±åˆ›å»ºæµ‹è¯•
```bash
$ curl -X POST http://localhost:3000/api/create-ai-sandbox-v2

# ç­‰å¾… 32 ç§’åè¿”å›ï¼š
âœ… {
  "success": true,
  "sandboxId": "ib7ytj0t12tujbnxkwva0",
  "url": "https://5173-ib7ytj0t12tujbnxkwva0.e2b.app",
  "provider": "e2b",
  "message": "Sandbox created and Vite React app initialized"
}
```

### é—®é¢˜å®šä½

**å‰ç«¯ä»£ç ä½ç½®**: `app/generation/page.tsx`

```typescript
// âŒ é—®é¢˜ä»£ç ï¼šæ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´
const response = await fetch('/api/create-ai-sandbox-v2', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({})
  // ç¼ºå°‘ signal: AbortSignal.timeout(XX) é…ç½®
});
```

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šå¢åŠ å‰ç«¯è¶…æ—¶æ—¶é—´ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `app/generation/page.tsx` ä¸­çš„ fetch è°ƒç”¨ï¼š

```typescript
// âœ… è§£å†³æ–¹æ¡ˆï¼šè®¾ç½® 60 ç§’è¶…æ—¶
const response = await fetch('/api/create-ai-sandbox-v2', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({}),
  signal: AbortSignal.timeout(60000) // 60 ç§’è¶…æ—¶
});
```

**ä¼˜ç‚¹**ï¼š
- ç®€å•å¿«é€Ÿ
- å…è®¸ E2B æœ‰è¶³å¤Ÿæ—¶é—´åˆ›å»ºæ²™ç®±
- ç”¨æˆ·ä½“éªŒæ”¹å–„ï¼ˆå¢åŠ ç­‰å¾…æç¤ºï¼‰

**ç¼ºç‚¹**ï¼š
- ç”¨æˆ·éœ€è¦ç­‰å¾…è¾ƒé•¿æ—¶é—´ï¼ˆ32ç§’ï¼‰

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ E2B æ¨¡æ¿åŠ é€Ÿåˆ›å»ºï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰

E2B æ”¯æŒé¢„æ„å»ºæ¨¡æ¿ï¼Œå¯ä»¥å°†åˆ›å»ºæ—¶é—´ä» 32ç§’ å‡å°‘åˆ° 5-10ç§’ã€‚

#### Step 1: åˆ›å»º E2B æ¨¡æ¿

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
npx e2b template build
```

#### Step 2: è·å–æ¨¡æ¿ ID

```bash
# æŸ¥çœ‹æ¨¡æ¿åˆ—è¡¨
npx e2b template list

# ç¤ºä¾‹è¾“å‡ºï¼š
# Template ID: vite-react-ts-v1
```

#### Step 3: ä¿®æ”¹æ²™ç®±åˆ›å»ºä»£ç 

åœ¨ `lib/sandbox/providers/e2b-provider.ts` ä¸­ï¼š

```typescript
async createSandbox(): Promise<SandboxInfo> {
  const sandbox = await Sandbox.create({
    apiKey: this.apiKey,
    template: 'vite-react-ts-v1', // ä½¿ç”¨æ¨¡æ¿ID
    timeout: 30000
  });
  // ...
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- åˆ›å»ºæ—¶é—´ï¼š32ç§’ â†’ 8-10ç§’
- å‰ç«¯ä¿æŒ 30ç§’ è¶…æ—¶å³å¯
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

### æ–¹æ¡ˆ 3ï¼šå¼‚æ­¥åˆ›å»º + è½®è¯¢çŠ¶æ€ï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰

å®ç°å¼‚æ­¥æ²™ç®±åˆ›å»ºï¼Œå‰ç«¯é€šè¿‡ WebSocket æˆ–è½®è¯¢è·å–çŠ¶æ€ã€‚

**ä¼˜ç‚¹**ï¼š
- ç”¨æˆ·ç•Œé¢ä¸ä¼šé˜»å¡
- å¯ä»¥æ˜¾ç¤ºè¯¦ç»†çš„åˆ›å»ºè¿›åº¦
- æ›´ä¸“ä¸šçš„ç”¨æˆ·ä½“éªŒ

**ç¼ºç‚¹**ï¼š
- å®ç°å¤æ‚åº¦é«˜
- éœ€è¦é‡æ„ç°æœ‰ä»£ç 

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | åˆ›å»ºæ—¶é—´ | å®ç°å¤æ‚åº¦ | ç”¨æˆ·ä½“éªŒ | æ¨èåº¦ |
|-----|---------|-----------|---------|--------|
| æ–¹æ¡ˆ1: å¢åŠ è¶…æ—¶ | 32ç§’ | â­ ç®€å• | â­â­ ä¸­ç­‰ | â­â­â­ |
| æ–¹æ¡ˆ2: ä½¿ç”¨æ¨¡æ¿ | 8-10ç§’ | â­â­ ä¸­ç­‰ | â­â­â­ å¥½ | â­â­â­â­â­ |
| æ–¹æ¡ˆ3: å¼‚æ­¥åˆ›å»º | 8-10ç§’ | â­â­â­ å¤æ‚ | â­â­â­â­ ä¼˜ç§€ | â­â­â­â­ |

## ğŸš€ æ¨èå®æ–½è®¡åˆ’

### é˜¶æ®µ 1ï¼šå¿«é€Ÿä¿®å¤ï¼ˆç«‹å³ï¼‰
- [x] è¯Šæ–­é—®é¢˜æ ¹å› 
- [ ] å®æ–½æ–¹æ¡ˆ1ï¼šå¢åŠ å‰ç«¯è¶…æ—¶åˆ° 60ç§’
- [ ] æ·»åŠ æ›´å¥½çš„åŠ è½½æç¤ºä¿¡æ¯
- [ ] æµ‹è¯•éªŒè¯ä¿®å¤æ•ˆæœ

### é˜¶æ®µ 2ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆ1-2å¤©å†…ï¼‰
- [ ] ç ”ç©¶ E2B æ¨¡æ¿åŠŸèƒ½
- [ ] åˆ›å»ºå¹¶æµ‹è¯•è‡ªå®šä¹‰æ¨¡æ¿
- [ ] å®æ–½æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ¨¡æ¿åŠ é€Ÿ
- [ ] ç›‘æ§åˆ›å»ºæ—¶é—´æ”¹å–„

### é˜¶æ®µ 3ï¼šä½“éªŒä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
- [ ] è®¾è®¡å¼‚æ­¥åˆ›å»ºæµç¨‹
- [ ] å®ç° WebSocket çŠ¶æ€æ¨é€
- [ ] æ·»åŠ è¯¦ç»†çš„è¿›åº¦æŒ‡ç¤ºå™¨
- [ ] A/B æµ‹è¯•ç”¨æˆ·æ»¡æ„åº¦

## ğŸ” åç»­ç›‘æ§å»ºè®®

1. **åˆ›å»ºæ—¶é—´ç›‘æ§**
   - è®°å½•æ¯æ¬¡æ²™ç®±åˆ›å»ºçš„è€—æ—¶
   - è®¾ç½®å‘Šè­¦é˜ˆå€¼ï¼ˆ> 40ç§’ï¼‰
   - åˆ†æä¸åŒæ—¶æ®µçš„æ€§èƒ½å·®å¼‚

2. **å¤±è´¥ç‡ç›‘æ§**
   - ç»Ÿè®¡æ²™ç®±åˆ›å»ºæˆåŠŸç‡
   - åˆ†ç±»å¤±è´¥åŸå› ï¼ˆè¶…æ—¶ vs å…¶ä»–é”™è¯¯ï¼‰
   - å»ºç«‹æ€§èƒ½åŸºçº¿

3. **ç”¨æˆ·ä½“éªŒæŒ‡æ ‡**
   - æ”¶é›†ç”¨æˆ·ç­‰å¾…æ—¶é—´åé¦ˆ
   - ç›‘æ§ä¸­é€”æ”¾å¼ƒç‡
   - ä¼˜åŒ–åŠ è½½åŠ¨ç”»å’Œæç¤ºæ–‡æ¡ˆ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [E2B Templates å®˜æ–¹æ–‡æ¡£](https://e2b.dev/docs/templates/overview)
- [E2B Sandbox API Reference](https://e2b.dev/docs/api/reference)
- [Next.js Timeout Configuration](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#maxduration)

---

**è¯Šæ–­å®Œæˆæ—¶é—´**: 2025-11-08
**è¯Šæ–­æ¨¡å¼**: Ultra-think
**é—®é¢˜ä¸¥é‡åº¦**: P1 - å½±å“ç”¨æˆ·ä½“éªŒï¼Œä½†æœ‰workaround
**ä¿®å¤ä¼˜å…ˆçº§**: é«˜
