# æ²™ç®±æ–¹æ¡ˆæ·±åº¦å¯¹æ¯”ä¸å›½å†…åŒ–å»ºè®®

## 1. ä¸‰ç§ç°æœ‰æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | Vercel Sandbox | E2B | é˜¿é‡Œäº‘æ–¹æ¡ˆ |
|------|---------------|-----|------------|
| **äº§å“å®šä½** | å®˜æ–¹æ²™ç®±æœåŠ¡ | ä¸“ä¸šä»£ç æ‰§è¡Œæ²™ç®± | éœ€è‡ªå»ºï¼ˆFC/ECIï¼‰ |
| **å›½å†…è®¿é—®** | âŒ æ…¢ï¼Œç»å¸¸è¢«å¢™ | âŒ å»¶è¿Ÿé«˜ | âœ… å¿«é€Ÿç¨³å®š |
| **å¼€å‘ä½“éªŒ** | âœ… ä¼˜ç§€ | âœ… ä¼˜ç§€ | âš ï¸ éœ€è¦è‡ªå·±å®ç° |
| **æˆæœ¬** | ä¸­ç­‰ | ä¸­ç­‰ | ä½-ä¸­ç­‰ |
| **å®æ—¶é¢„è§ˆ** | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âš ï¸ éœ€å®ç° |
| **Node.js æ”¯æŒ** | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âœ… FCæ”¯æŒ Node.js 20 |
| **API æ˜“ç”¨æ€§** | âœ… ç®€å• | âœ… ç®€å• | âš ï¸ å¤æ‚ |
| **æ–‡æ¡£å®Œå–„åº¦** | âœ… å®Œå–„ | âœ… å®Œå–„ | âœ… å®Œå–„ |
| **ç»´æŠ¤æˆæœ¬** | âœ… ä½ | âœ… ä½ | âŒ é«˜ |

---

## 2. é˜¿é‡Œäº‘å¯ç”¨æ–¹æ¡ˆè¯¦è§£

### æ–¹æ¡ˆ Aï¼šé˜¿é‡Œäº‘å‡½æ•°è®¡ç®— FC (Function Compute)

#### ä¼˜åŠ¿
- âœ… **Serverless**ï¼šæ— éœ€ç®¡ç†æœåŠ¡å™¨
- âœ… **æˆæœ¬ä½**ï¼šæŒ‰è°ƒç”¨æ¬¡æ•°ä»˜è´¹
- âœ… **Node.js 20 æ”¯æŒ**ï¼šæœ€æ–°è¿è¡Œæ—¶
- âœ… **å¿«é€Ÿéƒ¨ç½²**ï¼šç§’çº§å¯åŠ¨
- âœ… **å›½å†…è®¿é—®å¿«**ï¼šæ— ç½‘ç»œé—®é¢˜

#### åŠ£åŠ¿
- âŒ **ä¸é€‚åˆå®æ—¶äº¤äº’**ï¼šå†·å¯åŠ¨å»¶è¿Ÿ
- âŒ **æ‰§è¡Œæ—¶é•¿é™åˆ¶**ï¼šå•æ¬¡æœ€å¤š 15 åˆ†é’Ÿ
- âŒ **æ— æŒä¹…åŒ–æ–‡ä»¶ç³»ç»Ÿ**ï¼šæ–‡ä»¶å­˜å‚¨åœ¨ä¸´æ—¶ç›®å½•
- âŒ **ä¸æ”¯æŒå®æ—¶é¢„è§ˆ**ï¼šæ— æ³•åƒ Vite dev server é‚£æ ·å·¥ä½œ

#### é€‚ç”¨åœºæ™¯
- âœ… ä¸€æ¬¡æ€§ä»£ç ç”Ÿæˆä»»åŠ¡
- âœ… æ‰¹é‡æ–‡ä»¶å¤„ç†
- âŒ **ä¸é€‚åˆ Open Lovable çš„å®æ—¶é¢„è§ˆéœ€æ±‚**

---

### æ–¹æ¡ˆ Bï¼šé˜¿é‡Œäº‘å®¹å™¨æœåŠ¡ ACK + å¼¹æ€§å®¹å™¨å®ä¾‹ ECI

#### æŠ€æœ¯æ¶æ„
```
ç”¨æˆ·è¯·æ±‚ â†’ ACK æ§åˆ¶å™¨ â†’ åˆ›å»º ECI å®ä¾‹ â†’ è¿è¡Œ Vite Dev Server â†’ å®æ—¶é¢„è§ˆ
```

#### ä¼˜åŠ¿
- âœ… **å®Œæ•´å®¹å™¨ç¯å¢ƒ**ï¼šä¸ E2B ç±»ä¼¼
- âœ… **æŒä¹…åŒ–å­˜å‚¨**ï¼šæ”¯æŒæ–‡ä»¶ç³»ç»Ÿ
- âœ… **å®æ—¶é¢„è§ˆ**ï¼šå¯è¿è¡Œ Vite dev server
- âœ… **çµæ´»æ€§é«˜**ï¼šå®Œå…¨æ§åˆ¶å®¹å™¨ç¯å¢ƒ
- âœ… **å›½å†…è®¿é—®å¿«**ï¼šæ— ç½‘ç»œé—®é¢˜

#### åŠ£åŠ¿
- âŒ **éœ€è¦è‡ªå·±å®ç°æ²™ç®±é€»è¾‘**ï¼šå¤æ‚åº¦é«˜
- âŒ **æˆæœ¬è¾ƒé«˜**ï¼šæŒ‰å®¹å™¨å®ä¾‹è®¡è´¹
- âŒ **å¼€å‘å·¥ä½œé‡å¤§**ï¼šéœ€è¦ 2-3 å‘¨å®ç°
- âŒ **ç»´æŠ¤æˆæœ¬é«˜**ï¼šéœ€è¦æŒç»­ç»´æŠ¤

#### æŠ€æœ¯å®ç°è¦ç‚¹
```typescript
// éœ€è¦å®ç°çš„æ ¸å¿ƒåŠŸèƒ½
1. å®¹å™¨é•œåƒæ„å»ºï¼ˆDockerfileï¼‰
2. ACK API é›†æˆï¼ˆåˆ›å»º/é”€æ¯å®¹å™¨ï¼‰
3. ç½‘ç»œè®¿é—®æ§åˆ¶ï¼ˆå®‰å…¨éš”ç¦»ï¼‰
4. æ–‡ä»¶ç³»ç»Ÿç®¡ç†ï¼ˆä»£ç ä¸Šä¼ /ä¸‹è½½ï¼‰
5. å®æ—¶æ—¥å¿—æµï¼ˆVite è¾“å‡ºï¼‰
6. èµ„æºç›‘æ§å’Œé™åˆ¶
7. è‡ªåŠ¨æ¸…ç†æœºåˆ¶
```

#### é¢„ä¼°å·¥ä½œé‡
- **Phase 1**: å®¹å™¨é•œåƒæ„å»ºå’Œæµ‹è¯•ï¼ˆ3-4å¤©ï¼‰
- **Phase 2**: ACK API é›†æˆï¼ˆ3-4å¤©ï¼‰
- **Phase 3**: å®‰å…¨å’Œç½‘ç»œé…ç½®ï¼ˆ2-3å¤©ï¼‰
- **Phase 4**: å®æ—¶é¢„è§ˆå’Œæ—¥å¿—æµï¼ˆ2-3å¤©ï¼‰
- **Phase 5**: æµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ2-3å¤©ï¼‰
- **æ€»è®¡**: 12-17 å¤©ï¼ˆçº¦ 2.5-3.5 å‘¨ï¼‰

#### æˆæœ¬ä¼°ç®—ï¼ˆä¸Šæµ·åŒºåŸŸï¼‰
```
ECI å®ä¾‹ï¼š
- 2C4G é…ç½®
- æŒ‰ç§’è®¡è´¹ï¼šÂ¥0.00012/ç§’/æ ¸
- å•ä¸ªæ²™ç®±è¿è¡Œ 15 åˆ†é’Ÿï¼š2æ ¸ * 900ç§’ * 0.00012 = Â¥0.216
- æ¯å¤© 100 ä¸ªæ²™ç®±ï¼šÂ¥21.6/å¤© = Â¥648/æœˆ

ç½‘ç»œè´¹ç”¨ï¼š
- å…¬ç½‘æµé‡ï¼šÂ¥0.8/GB
- é¢„è®¡æ¯æœˆ 50GBï¼šÂ¥40/æœˆ

æ€»è®¡ï¼šçº¦ Â¥700/æœˆï¼ˆ100 ä¸ªæ²™ç®±/å¤©ï¼‰
```

---

### æ–¹æ¡ˆ Cï¼šè…¾è®¯äº‘ Serverless Framework + äº‘å‡½æ•°

#### ç‰¹ç‚¹
- ç±»ä¼¼é˜¿é‡Œäº‘ FC
- æ”¯æŒ Node.js 18
- åŒæ ·ä¸é€‚åˆå®æ—¶é¢„è§ˆåœºæ™¯

---

## 3. æ¨èæ–¹æ¡ˆï¼šæ··åˆæ¶æ„

### ğŸ¯ æœ€ä½³å®è·µï¼šä¿ç•™å›½é™…æ–¹æ¡ˆ + å¯é€‰å›½å†…æ–¹æ¡ˆ

```typescript
export enum SandboxProvider {
  VERCEL = 'vercel',      // é»˜è®¤ï¼Œé€‚åˆå›½é™…ç”¨æˆ·
  E2B = 'e2b',           // å¤‡é€‰ï¼Œé€‚åˆå›½é™…ç”¨æˆ·
  ALIYUN_ECI = 'aliyun-eci'  // å¯é€‰ï¼Œé€‚åˆå›½å†…ç”¨æˆ·ï¼ˆéœ€è‡ªå»ºï¼‰
}
```

### å®æ–½ç­–ç•¥

#### é˜¶æ®µ 1ï¼šä¿ç•™ç°æœ‰æ–¹æ¡ˆï¼ˆ0 å·¥æ—¶ï¼‰
- âœ… **ä¿ç•™** Vercel Sandboxï¼ˆé»˜è®¤ï¼‰
- âœ… **ä¿ç•™** E2B ä½œä¸ºå¤‡é€‰
- âœ… ä¸åšä»»ä½•æ”¹åŠ¨ï¼Œç¡®ä¿å›½é™…ç”¨æˆ·ä½“éªŒ

#### é˜¶æ®µ 2ï¼šå¯é€‰å›½å†…ä¼˜åŒ–ï¼ˆ12-17 å¤©ï¼‰
**ä»…åœ¨ç¡®å®æœ‰å¤§é‡å›½å†…ç”¨æˆ·éœ€æ±‚æ—¶å®æ–½**

```typescript
// æ²™ç®±æä¾›å•†é…ç½®
export const SANDBOX_CONFIG = {
  // é»˜è®¤ä½¿ç”¨ Vercelï¼ˆä¿æŒä¸å˜ï¼‰
  default: 'vercel',

  // å›½å†…ç”¨æˆ·å¯é€‰é…ç½®ï¼ˆæ–°å¢ï¼‰
  providers: {
    vercel: { region: 'global' },      // ä¿ç•™
    e2b: { region: 'global' },         // ä¿ç•™
    aliyunEci: {                       // æ–°å¢ï¼ˆå¯é€‰ï¼‰
      region: 'cn-shanghai',
      enabled: false,  // é»˜è®¤ç¦ç”¨ï¼Œéœ€æ‰‹åŠ¨å¼€å¯
    }
  }
};
```

---

## 4. å†³ç­–å»ºè®®

### âœ… æ¨èæ–¹æ¡ˆï¼ˆæœ€å°æ”¹åŠ¨ï¼‰

**ä¿æŒç°çŠ¶ï¼Œä¸æ”¹é€ æ²™ç®±**

**ç†ç”±**ï¼š
1. **å¤æ‚åº¦å¤ªé«˜**ï¼šè‡ªå»ºé˜¿é‡Œäº‘æ²™ç®±éœ€è¦ 2-3 å‘¨å¼€å‘ + æŒç»­ç»´æŠ¤
2. **æ€§ä»·æ¯”ä½**ï¼šæŠ•å…¥äº§å‡ºæ¯”ä¸é«˜
3. **ç”¨æˆ·è§„æ¨¡æœªçŸ¥**ï¼šä¸ç¡®å®šå›½å†…ç”¨æˆ·å æ¯”
4. **å¯ç”¨æ›¿ä»£æ–¹æ¡ˆ**ï¼š
   - å›½å†…ç”¨æˆ·å¯ä½¿ç”¨ Cloudflare CDN åŠ é€Ÿ Vercel
   - æˆ–ä½¿ç”¨ VPN è®¿é—®
   - æˆ–éƒ¨ç½²åˆ°å›½å†… CDN

### âš ï¸ å¤‡é€‰æ–¹æ¡ˆï¼ˆå¦‚æœå›½å†…éœ€æ±‚å¼ºçƒˆï¼‰

**ä»…åœ¨ä»¥ä¸‹æƒ…å†µè€ƒè™‘è‡ªå»ºé˜¿é‡Œäº‘æ²™ç®±**ï¼š
- âœ… æœ‰æ˜ç¡®çš„å›½å†…å¤§å®¢æˆ·éœ€æ±‚
- âœ… æ„¿æ„æŠ•å…¥ 2-3 å‘¨å¼€å‘æ—¶é—´
- âœ… æœ‰ä¸“äººè´Ÿè´£åç»­ç»´æŠ¤
- âœ… é¢„ç®—å……è¶³ï¼ˆçº¦ Â¥1000+/æœˆè¿è¥æˆæœ¬ï¼‰

---

## 5. Phase è®¡åˆ’è°ƒæ•´å»ºè®®

### åŸè®¡åˆ’ä¿æŒä¸å˜
- âœ… Phase 1-8 æŒ‰åŸè®¡åˆ’æ‰§è¡Œ
- âœ… æ²™ç®±éƒ¨åˆ†ä¿æŒç°çŠ¶ï¼ˆVercel + E2Bï¼‰

### å¯é€‰ Phase 9ï¼ˆæœªæ¥è€ƒè™‘ï¼‰
**Phase 9: é˜¿é‡Œäº‘å®¹å™¨æ²™ç®±ï¼ˆå¯é€‰ï¼‰**
- é¢„è®¡æ—¶é—´ï¼š12-17 å¤©
- ä¾èµ–ï¼šPhase 1-8 å®Œæˆåè¯„ä¼°éœ€æ±‚
- äº¤ä»˜ç‰©ï¼šé˜¿é‡Œäº‘ ECI æ²™ç®±æä¾›å•†

**è§¦å‘æ¡ä»¶**ï¼š
- å›½å†…ç”¨æˆ·å æ¯” > 50%
- æ”¶åˆ° 10+ ä¸ªæ²™ç®±è®¿é—®é—®é¢˜åé¦ˆ
- æœ‰æ˜ç¡®çš„å•†ä¸šéœ€æ±‚

---

## 6. æŠ€æœ¯å®ç°å‚è€ƒï¼ˆå¦‚æœæœªæ¥éœ€è¦ï¼‰

### é˜¿é‡Œäº‘ ECI æ²™ç®±å®ç°æ¶æ„

```typescript
// lib/sandbox/providers/aliyun-eci-provider.ts

/**
 * é˜¿é‡Œäº‘ ECI æ²™ç®±æä¾›å•†ï¼ˆæœªæ¥å¯é€‰å®ç°ï¼‰
 */
export class AliyunECIProvider extends SandboxProvider {
  private eciClient: ECI.Client;

  async createSandbox(): Promise<SandboxInfo> {
    // 1. åˆ›å»º ECI å®ä¾‹
    const instance = await this.eciClient.createContainerGroup({
      containerGroupName: `sandbox-${nanoid()}`,
      containers: [{
        name: 'vite-app',
        image: 'registry.cn-shanghai.aliyuncs.com/your-repo/vite-sandbox:latest',
        cpu: 2,
        memory: 4,
        ports: [{ port: 3000, protocol: 'TCP' }],
      }],
      restartPolicy: 'Never',
      // å®‰å…¨ç»„é…ç½®
      securityGroupId: 'sg-xxx',
      // è‡ªåŠ¨åˆ†é…å…¬ç½‘ IP
      eipBandwidth: 5,
    });

    // 2. ç­‰å¾…å®ä¾‹è¿è¡Œ
    await this.waitForRunning(instance.containerGroupId);

    // 3. è·å–å…¬ç½‘è®¿é—®åœ°å€
    const publicIp = await this.getPublicIp(instance.containerGroupId);

    return {
      sandboxId: instance.containerGroupId,
      url: `http://${publicIp}:3000`,
      provider: 'aliyun-eci',
      createdAt: new Date(),
    };
  }

  async runCommand(command: string): Promise<CommandResult> {
    // ä½¿ç”¨ ECI çš„ exec API
    return await this.eciClient.execContainerCommand({
      containerGroupId: this.sandboxId,
      containerName: 'vite-app',
      command: ['/bin/sh', '-c', command],
    });
  }

  async writeFile(path: string, content: string): Promise<void> {
    // é€šè¿‡ exec å†™å…¥æ–‡ä»¶
    const escapedContent = content.replace(/'/g, "'\\''");
    await this.runCommand(`echo '${escapedContent}' > ${path}`);
  }

  async terminate(): Promise<void> {
    // åˆ é™¤å®¹å™¨ç»„
    await this.eciClient.deleteContainerGroup({
      containerGroupId: this.sandboxId,
    });
  }
}
```

### Dockerfile å‚è€ƒ
```dockerfile
FROM node:20-alpine

# å®‰è£… Vite å’Œä¾èµ–
WORKDIR /app
RUN npm install -g vite

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨å‘½ä»¤
CMD ["vite", "--host", "0.0.0.0", "--port", "3000"]
```

---

## 7. æ€»ç»“ä¸å»ºè®®

### å½“å‰æœ€ä½³å†³ç­–ï¼šä¸æ”¹é€ æ²™ç®±

**ç†ç”±**ï¼š
1. **ç°æœ‰æ–¹æ¡ˆè¶³å¤Ÿå¥½**ï¼šVercel + E2B åœ¨å…¨çƒèŒƒå›´å†…éƒ½æ˜¯æœ€ä½³å®è·µ
2. **æ”¹é€ æˆæœ¬è¿‡é«˜**ï¼šè‡ªå»ºéœ€è¦ 2-3 å‘¨ + æŒç»­ç»´æŠ¤
3. **å›½å†…è®¿é—®å¯ä¼˜åŒ–**ï¼šé€šè¿‡ CDN åŠ é€Ÿè§£å†³
4. **èšç„¦æ ¸å¿ƒä»·å€¼**ï¼šAI æ¨¡å‹å’Œçˆ¬å–ä¼˜åŒ–æ›´é‡è¦

### æœªæ¥è¯„ä¼°æ ‡å‡†

å¦‚æœä»¥ä¸‹æ¡ä»¶æ»¡è¶³ï¼Œå†è€ƒè™‘è‡ªå»ºé˜¿é‡Œäº‘æ²™ç®±ï¼š
- âœ… å›½å†…ç”¨æˆ· > 1000 æ´»è·ƒç”¨æˆ·/æœˆ
- âœ… æ”¶åˆ° > 50 æ¬¡æ²™ç®±è®¿é—®é—®é¢˜åé¦ˆ
- âœ… æœ‰æ˜ç¡®çš„ä¼ä¸šå®¢æˆ·è¦æ±‚å›½å†…éƒ¨ç½²
- âœ… æœ‰ä¸“èŒå›¢é˜Ÿè´Ÿè´£ç»´æŠ¤

### ç«‹å³æ‰§è¡Œçš„ä¼˜åŒ–ï¼ˆä½æˆæœ¬ï¼‰

å¯ä»¥å…ˆåšè¿™äº›ç®€å•ä¼˜åŒ–ï¼š
1. **æ–‡æ¡£è¯´æ˜**ï¼šæç¤ºå›½å†…ç”¨æˆ·ä½¿ç”¨ Cloudflare åŠ é€Ÿ
2. **è‡ªåŠ¨æ£€æµ‹**ï¼šæ£€æµ‹ç”¨æˆ·ç½‘ç»œï¼Œæ¨èåˆé€‚çš„è®¿é—®æ–¹å¼
3. **é™çº§æ–¹æ¡ˆ**ï¼šVercel ä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ° E2B

---

**åˆ¶å®šæ—¶é—´**: 2025-11-07
**ç»“è®º**: ä¿æŒç°æœ‰æ²™ç®±æ–¹æ¡ˆï¼ˆVercel + E2Bï¼‰ï¼Œä¸åšå›½å†…åŒ–æ”¹é€ 
**å»ºè®®**: Phase 1-8 æŒ‰åŸè®¡åˆ’æ‰§è¡Œï¼Œèšç„¦ AI æ¨¡å‹å’Œçˆ¬å–ä¼˜åŒ–
